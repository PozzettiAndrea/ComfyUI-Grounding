name: Real Model Integration Tests

on:
  # Run on schedule (weekly, every Monday at 3 AM UTC)
  schedule:
    - cron: '0 3 * * 1'

  # Allow manual trigger
  workflow_dispatch:

  # Run on push to main branches
  push:
    branches: [main, master, dev]

jobs:
  test-real-models:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Real model tests can take longer

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        cache: 'pip'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-mock pytest-asyncio
        pip install opencv-python-headless
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: Create model cache directory
      run: |
        mkdir -p ~/.cache/huggingface

    - name: Cache models
      uses: actions/cache@v4
      with:
        path: ~/.cache/huggingface
        key: ${{ runner.os }}-huggingface-models-${{ hashFiles('tests/integration_real/*.py') }}
        restore-keys: |
          ${{ runner.os }}-huggingface-models-

    - name: Run real model tests
      run: |
        pytest tests/integration_real/ -v -m real_model --tb=short
      env:
        PYTHONPATH: ${{ github.workspace }}
        HF_HUB_DISABLE_TELEMETRY: 1

    - name: Test summary
      if: always()
      run: |
        echo "## Real Model Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Real model tests completed. Check logs above for detailed results." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Visual test outputs have been uploaded as artifacts (if available)." >> $GITHUB_STEP_SUMMARY

    - name: Upload test visual outputs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-visual-outputs
        path: tests/test_outputs/*.png
        retention-days: 30
        if-no-files-found: ignore

    - name: Upload test artifacts
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-failures
        path: |
          pytest-results/
          tests/test_outputs/
          *.log
